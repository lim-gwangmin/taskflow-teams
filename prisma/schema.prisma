generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider  = "postgresql"
  url       = env("PRISMA_DATABASE_URL")
  directUrl = env("DATABASE_URL")
}

// ê¶Œí•œ Enum
enum Role {
  ADMIN // ê´€ë¦¬ì
  MEMBER // ê·¸ë£¹ ë©¤ë²„
  GUEST // 
  VIEWER // 
}
// ìš”ì²­ ìƒíƒœ Enum
enum RequestStatus {
  PENDING // ëŒ€ê¸°ì¤‘
  APPROVED // ìŠ¹ì¸ë¨
  DENIED // ê±°ì ˆë¨
}
// ìš”ì²­ ìœ í˜• Enum
enum RequestType {
  APPLICATION // ìœ ì €ê°€ ê·¸ë£¹ì— ê°€ì… ì‹ ì²­
  INVITATION // ê·¸ë£¹ì´ ìœ ì €ë¥¼ ì´ˆëŒ€
}


// ì´ë©”ì¼ ì¸ì¦ ìŠ¤í‚¤ë§ˆ
model VerificationToken {
  id               String   @id @default(uuid())
  email            String   @unique
  verificationCode String   @unique
  expiresAt        DateTime

  @@map("verification_tokens")
}

// ìœ ì € ì •ë³´ ìŠ¤í‚¤ë§ˆ
model User {
  seq           Int      @id @default(autoincrement()) // ìœ ì € ê³ ìœ  ê°’
  email         String   @unique // ìœ ì € ì´ë©”ì¼ 
  name          String // ìœ ì € ì´ë¦„
  nickname      String // ìœ ì € ë‹‰ë„¤ì„ ë° ê³ ìœ  í•´ì‹œì½”ë“œ ê°’ ì• ë¬¸ì
  discriminator String // ìœ ì € ê³ ìœ  í•´ì‹œì½”ë“œ ê°’ ë’¤ ìˆ«ì 4ìë¦¬
  password      String // ìœ ì € ë¹„ë°€ë²ˆí˜¸
  createdAt     DateTime @default(now()) // ê³„ì • ìƒì„±ì¼

  // --- ê´€ê³„ í•„ë“œ ---
  Group             Group[]
  memberships       Membership[] // ì´ ìœ ì €ê°€ ì†í•œ ê·¸ë£¹ ë©¤ë²„ì‹­ ëª©ë¡
  membershipRequest MembershipRequest[] // ì´ ìœ ì €ê°€ ì†í•œ ê·¸ë£¹ ì´ˆëŒ€ ë° ì´ˆëŒ€ ìš”ì²­ ëª©ë¡
  posts             Post[] // ì´ ìœ ì €ê°€ ì‘ì„±í•œ ê²Œì‹œê¸€ ëª©ë¡ (ìˆ˜ì •)

  @@unique([nickname, discriminator])
  @@map("users")
}

// ê·¸ë£¹ ì •ë³´ ìŠ¤í‚¤ë§ˆ
model Group {
  id          String   @id @default(uuid())
  seq         Int      @unique @default(autoincrement()) // ê³ ìœ í•œ ìˆ«ì ID
  name        String   // ê·¸ë£¹ ì´ë¦„ 
  description String   // ê·¸ë£¹ ì†Œê°œ 
  userLimit   Int      @default(20) // ê°€ì…ì ìˆ˜ ì œí•œ
  adminSeq    Int      // ê·¸ë£¹ ê´€ë¦¬ì ê³ ìœ  ì•„ì´ë”” 
  createdAt   DateTime @default(now()) // ê·¸ë£¹ ìƒì„±ì¼
  no          Int      @unique @default(autoincrement()) // ê·¸ë£¹ ìƒì„± ìˆœì„œ (ìµœì‹ /ì˜¤ë˜ëœìˆœ ì •ë ¬ìš©)

  // --- ê´€ê³„ í•„ë“œ ---
  user        User     @relation(fields: [adminSeq], references: [seq])
  memberships       Membership[] // ì´ ê·¸ë£¹ì— ì†í•œ ë©¤ë²„ì‹­ ëª©ë¡
  membershipRequest MembershipRequest[] // ì´ ê·¸ë£¹ì— ëŒ€í•œ ì´ˆëŒ€ ë° ì´ˆëŒ€ ìš”ì²­ ëª©ë¡
  posts             Post[] // ì´ ê·¸ë£¹ì— ì‘ì„±ëœ ê²Œì‹œê¸€ ëª©ë¡
}

// user, group ì‚¬ì´ ê´€ê³„ì™€ ì—­í•  ì¤‘ê°„ í…Œì´ë¸” ìŠ¤í‚¤ë§ˆ
model Membership {
  userSeq  Int // User.seq(Int)ì™€ íƒ€ì… ì¼ì¹˜
  groupId  String // Group.id(String)ì™€ íƒ€ì… ì¼ì¹˜
  groupSeq Int //  Group.seq(Int)ì™€ íƒ€ì… ì¼ì¹˜ (ìˆ«ì ID ì°¸ì¡°)
  joinedAt DateTime @default(now()) // ê·¸ë£¹ ê°€ì…ì¼
  // --- ê´€ê³„ í•„ë“œ ---
  group    Group    @relation(fields: [groupId], references: [id])
  role     Role
  user     User     @relation(fields: [userSeq], references: [seq])

  // ë³µí•© ê¸°ë³¸ í‚¤ (Composite Primary Key)
  @@id([userSeq, groupId])
  // ğŸ”½ ë³µí•© ì¸ë±ìŠ¤ ì¶”ê°€ (groupId ëŒ€ì‹  groupSeqë¡œ ê·¸ë£¹ì„ íŠ¹ì •í•  ë•Œ ì‚¬ìš©)
  @@index([groupSeq])
}

// ê·¸ë£¹ ê°€ì… ì‹ ì²­ í…Œì´ë¸” 
model MembershipRequest {
  seq      Int @id @default(autoincrement())

  // ì–´ëŠ ê·¸ë£¹ì— ëŒ€í•œ ìš”ì²­ì¸ì§€ (groupSeq ì‚¬ìš©)
  groupSeq Int
  group    Group @relation(fields: [groupSeq], references: [seq])

  // ì–´ë–¤ ìœ ì €ì— ëŒ€í•œ ìš”ì²­ì¸ì§€
  userSeq Int

  // 1. ìš”ì²­ì˜ í˜„ì¬ ìƒíƒœ (í•„ìˆ˜!)
  status RequestStatus @default(PENDING)

  // 2. ìœ ì €ê°€ ì‹ ì²­ or ê·¸ë£¹ì´ ì´ˆëŒ€
  type    RequestType
  message String? // ê°€ì… ì‹ ì²­ ë©”ì‹œì§€ ë˜ëŠ” ì´ˆëŒ€ ë©”ì‹œì§€ (ì„ íƒ ì‚¬í•­)

  // 3. ì‚¬ìš©ìê°€ ì œì•ˆí•œ 'ê°€ì…ì‹ ì²­ í˜„ì¬ ë‚ ì§œ'
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt // ìƒíƒœ ë³€ê²½ ì‹œê°ì„ ì¶”ì í•˜ê¸° ìœ„í•´ ì¶”ê°€
  user      User     @relation(fields: [userSeq], references: [seq]) 

  // í•œ ìœ ì €ê°€ í•œ ê·¸ë£¹ì— ë™ì¼í•œ ìœ í˜•ì˜ ìš”ì²­ì„ ì¤‘ë³µìœ¼ë¡œ ë³´ë‚¼ ìˆ˜ ì—†ë„ë¡ ì„¤ì •
  @@unique([userSeq, groupSeq, type])
}

// ê·¸ë£¹ ë‚´ ì‘ì„±í•œ ê¸€ ì •ë³´ ìŠ¤í‚¤ë§ˆ
model Post {
  seq     String @id @default(uuid())
  title   String
  content String

  authorId Int // User.Seq(Int)ì™€ íƒ€ì… ì¼ì¹˜ (ìˆ˜ì •)
  groupId  String // Group.id(String)ì™€ íƒ€ì… ì¼ì¹˜

  // --- ê´€ê³„ í•„ë“œ ---
  author User  @relation(fields: [authorId], references: [seq])
  group  Group @relation(fields: [groupId], references: [id])
}
